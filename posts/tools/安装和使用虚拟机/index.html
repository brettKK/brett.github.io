<!DOCTYPE html>
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/styles/default.min.css">
<script src="https://cdn.bootcss.com/highlight.js/9.12.0/languages/yaml.min.js"></script>
<html lang="zh-cn">
  <head>
    <title>mac上安装和使用虚拟机 | brettkk</title>

    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">    
<meta name="viewport" content="width=device-width,minimum-scale=1">
<meta name="description" content="必要性 🔗 因为使用的是mac笔记本，实验和开发上需要利用lin">
<meta name="generator" content="Hugo 0.103.1" />


  <META NAME="ROBOTS" CONTENT="NOINDEX, NOFOLLOW">


<link href="https://cdn.bootcss.com/highlight.js/9.15.10/styles/zenburn.min.css" rel="stylesheet">
<script src="https://cdn.bootcss.com/highlight.js/9.15.10/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>


<link rel="stylesheet" href="http://brettkk.github.io/css/syntax.css" />


<link rel="stylesheet" href="/css/style.css">



<link rel="shortcut icon" href="/images/favicon.ico" type="image/x-icon" />




  
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.13/dist/katex.min.css" integrity="sha384-RZU/ijkSsFbcmivfdRBQDtwuwVqK7GMOw6IMvKyeWL2K5UAlyp6WonmB8m7Jd0Hn" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.13.13/dist/katex.min.js" integrity="sha384-pK1WpvzWVBQiP0/GjnvRxV4mOb0oxFuyRxJlk6vVw146n3egcN5C925NCP7a7BY8" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.13.13/dist/contrib/auto-render.min.js" integrity="sha384-vZTG03m+2yp6N6BNi5iM4rW4oIwk5DfcNdFfxkk9ZWpDriOkXX8voJBFrAO7MpVl" crossorigin="anonymous"
    onload="renderMathInElement(document.body);"></script>




  </head>

  <body>
    <nav class="navigation">
	
		<a href="/"> <span class="arrow">←</span>Home</a>
	
	<a href="/posts">Archive</a>
	<a href="/tags">Tags</a>
	<a href="/about">About</a>

	

	
</nav>


    <main class="main">
      

<section id="single">
    <h1 class="title">mac上安装和使用虚拟机</h1>

    <div class="tip">
        <time datetime="2020-09-18 11:33:56 &#43;0800 CST">Sep 18, 2020</time>
        <span class="split">
          ·
        </span>
        <span>
          1022 words
        </span>
        <span class="split">
          ·
        </span>
        <span>
          3 minute read
        </span>
    </div>

    
    
        
  
    <aside class="toc">
      <details>
          <summary>Table of Contents
          </summary>
          <div>
              <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#必要性">必要性</a></li>
        <li><a href="#其他平台的方案">其他平台的方案</a></li>
        <li><a href="#macos-m1下安装虚拟机">macos m1下安装虚拟机</a></li>
        <li><a href="#macos-m1-arch">macos m1 arch</a>
          <ul>
            <li><a href="#遇到的问题">遇到的问题</a></li>
          </ul>
        </li>
        <li><a href="#其他">其他</a></li>
      </ul>
    </li>
  </ul>
</nav>
          </div>
      </details>
    </aside>
  


    


    <div class="content">
      <h2 id="必要性">必要性 <a href="#%e5%bf%85%e8%a6%81%e6%80%a7" class="anchor">🔗</a></h2><p><font color=blue> 因为使用的是mac笔记本，实验和开发上需要利用linux环境下的工具（如gcc，gdb之类），所以在mac的宿主机上虚拟化出linux很有必要。 </font><br></p>
<h2 id="其他平台的方案">其他平台的方案 <a href="#%e5%85%b6%e4%bb%96%e5%b9%b3%e5%8f%b0%e7%9a%84%e6%96%b9%e6%a1%88" class="anchor">🔗</a></h2><p>windows下 vscode 安装Windows Subsystem for Linux (WSL)插件，即可</p>
<p>VirtualBox supports only x86 hardware.</p>
<p>Ubuntu is available not only on x86 architectures, but also has ARM-based versions.</p>
<p>VMWare 虚拟机产品（付费）。</p>
<h2 id="macos-m1下安装虚拟机">macos m1下安装虚拟机 <a href="#macos-m1%e4%b8%8b%e5%ae%89%e8%a3%85%e8%99%9a%e6%8b%9f%e6%9c%ba" class="anchor">🔗</a></h2><p>在m1 arch下 virtual box和VMWare虚拟机产品不支持。</p>
<h2 id="macos-m1-arch">macos m1 arch <a href="#macos-m1-arch" class="anchor">🔗</a></h2><p>multipass 可以支持在macos下虚拟化出ubuntu操作系统，基本上满足了开发需求。</p>
<p>multipass find</p>
<p>multipass launch 22.04 -n primary -c 2 -m 4G -d 50G</p>
<p>multipass list 查看虚拟机IP</p>
<p>multipass shell</p>
<p>sudo apt install ubuntu-desktop xrdp -y</p>
<p>vsocde ssh到本地虚拟化出来的ubuntu系统。</p>
<h3 id="遇到的问题">遇到的问题 <a href="#%e9%81%87%e5%88%b0%e7%9a%84%e9%97%ae%e9%a2%98" class="anchor">🔗</a></h3><pre tabindex="0"><code>#ssh ubuntu@192.168.64.2
ubuntu@192.168.64.2: Permission denied (publickey).

# ssh ubuntu@192.168.64.3
Load key &#34;.ssh/id_rsa.pub&#34; invalid format 
ubuntu@192.168.64.3: Permission denied (publickey).
</code></pre><p>原因： 在宿主机~/.ssh/config中 IdentityFile ~/.ssh/id_rsa.pub。 配置错误。
公钥配置在vm的~/.ssh/authorized_keys中。 在宿主机上ssh时利用私钥进行登陆认证。
所以在宿主机IdentityFile ~/.ssh/id_rsa.pub -&gt; IdentityFile ~/.ssh/id_rsa（私钥）。</p>
<pre tabindex="0"><code>通过mulipass client里open shell打开primary 实例，可能出现
Can&#39;t open instance, stuck in Starting phase。
原因： 上一部修改ubuntu中~/.ssh/authorized_keys时不是采用的append新public key，采用覆盖。
所以在修改authorized_keys时原有public key最好backup一份。
</code></pre><p>打开远程的文件夹包含大量文件时（例如打开linux kernel文件夹代码），出现Connection to server got closed. Server will not be restarted。</p>
<pre tabindex="0"><code>Visual Studio Code is unable to watch for file changes in this large workspace&#34; (error ENOSPC).



解决办法参考：https://code.visualstudio.com/docs/setup/linux#_visual-studio-code-is-unable-to-watch-for-file-changes-in-this-large-workspace-error-enospc
</code></pre><pre tabindex="0"><code>在linux-5.19下
ubuntu$ ctags -R
no left space on disk.

尝试调整虚拟机的disk资源限制。 
sudo vim /var/root/Library/Application\ Support/multipassd/qemu/multipassd-vm-instances.json
更改primary的disk限制，重启启动vm后不起作用。

接着尝试：
 sudo  /Library/Application\ Support/com.canonical.multipass/bin/qemu-img info /var/root/Library/Application\ Support/multipassd/qemu/vault/instances/primary/ubuntu-22.04-server-cloudimg-arm64.img

 sudo  /Library/Application\ Support/com.canonical.multipass/bin/qemu-img snapshot -d suspend  /var/root/Library/Application\ Support/multipassd/qemu/vault/instances/primary/ubuntu-22.04-server-cloudimg-arm64.img

 sudo  /Library/Application\ Support/com.canonical.multipass/bin/qemu-img resize /var/root/Library/Application\ Support/multipassd/qemu/vault/instances/primary/ubuntu-22.04-server-cloudimg-arm64.img +10G

 Image resized.
</code></pre><p><a href="https://multipass.run/docs/modify-an-instance#heading--set-the-cpu-ram-or-disk-of-an-instance" target="_blank" rel="noopener">https://multipass.run/docs/modify-an-instance#heading--set-the-cpu-ram-or-disk-of-an-instance</a></p>
<p><a href="https://zhuanlan.zhihu.com/p/435237515" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/435237515</a>
launch failed: cannot connect to the multipass socket
解决办法：sudo launchctl load /Library/LaunchDaemons/com.canonical.multipassd.plist</p>
<p>image resized成功，但是disk size仍然是5G。。。</p>
<h2 id="其他">其他 <a href="#%e5%85%b6%e4%bb%96" class="anchor">🔗</a></h2><p>本地安装付费的虚拟机。<br>
购买云主机， 例如腾讯云的轻量应用服务器。</p>

    </div>

    
        <div class="tags">
            
                <a href="http://brettkk.github.io/tags/soft_tools">soft_tools</a>
            
        </div>
    
    
    

</section>


    </main>
    
    <footer id="footer">
    

    <script src="https://utteranc.es/client.js"
repo="brettKK/brettkk.github.io"
issue-term="title"
theme="github-light"
crossorigin="anonymous"
async>
</script>  

    <div class="copyright">
    
       © Copyright 
       2022 
       <span class="split">
        <svg fill="#bbbbbb" width="15" height="15" version="1.1" id="heart-15" xmlns="http://www.w3.org/2000/svg" width="15px" height="15px" viewBox="0 0 15 15">
  <path d="M13.91,6.75c-1.17,2.25-4.3,5.31-6.07,6.94c-0.1903,0.1718-0.4797,0.1718-0.67,0C5.39,12.06,2.26,9,1.09,6.75&#xA;&#x9;C-1.48,1.8,5-1.5,7.5,3.45C10-1.5,16.48,1.8,13.91,6.75z"/>
</svg>
       </span>
       
    
    </div>

    
      <div class="powerby">
        Powered by <a href='http://www.gohugo.io/'>Hugo</a> Theme By <a href='https://github.com/nodejh/hugo-theme-cactus-plus'>nodejh</a>
      </div>
    
</footer>




  </body>
</html>
